# Skill Clusters Population Scripts

## Overview

This directory contains scripts to populate the `skill_clusters` table with merge results from CSV files generated by the skills merge processing system.

## Scripts

### 1. `populate_skill_clusters.rb`

**Purpose**: Reads CSV files with naming pattern `skills_details_domain_*.csv` and populates the new columns in the `skill_clusters` table.

**Features**:
- Automatically discovers CSV files matching the pattern `skills_details_domain_X_cluster_Y.csv`
- Extracts domain_id and cluster_id from filename
- Updates `outcome_id`, `merge_with_skill_id`, and `reason` columns
- Provides detailed progress reporting and error handling
- Handles empty/null merge targets correctly

**Usage**:
```bash
ruby populate_skill_clusters.rb
```

**CSV File Format Expected**:
```csv
skill_id,outcome_id,merge_with_skill_id,reason
123,1,,""
456,2,789,"Specific tool, covered by more general skill"
```

## Database Schema

The scripts work with these columns added to `skill_clusters` table:

```sql
-- Outcome of the merge decision (1=keep, 2=merge, 3=uncertain)
outcome_id: integer

-- ID of skill to merge with (only when outcome_id = 2)
merge_with_skill_id: integer  

-- Human-readable reason for the decision
reason: text
```

## Merge Outcomes

- **Outcome 1**: Keep as canonical skill (no merge needed)
- **Outcome 2**: Merge with another skill (merge_with_skill_id specifies target)
- **Outcome 3**: Uncertain - needs manual review

## Example Results

After running the population script:
- **1,922 records** updated from `skills_details_domain_1_cluster_1.csv`
- **1,263 skills** marked as canonical (outcome 1)
- **654 skills** marked for merging (outcome 2)
- **5 skills** marked as uncertain (outcome 3)
- **0 data quality issues** detected

## Error Handling

The scripts handle:
- Missing CSV files gracefully
- Invalid filename formats
- Missing SkillCluster records (logged as warnings)
- Empty/null merge target values
- Database constraint violations

## File Processing Pattern

CSV files should follow this naming convention:
```
skills_details_domain_{domain_id}_cluster_{cluster_id}.csv
```

Example: `skills_details_domain_1_cluster_1.csv` processes skills from domain 1, cluster 1.
